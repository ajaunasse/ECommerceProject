{% extends ":layout:Public/layout.html.twig" %}
{% set totalHT  = 0 %}
{% set totalTTC = 0 %}
{% set refTva   = {} %}
{% set tva = 0 %}
{% set length =  products|length > 0  %}

{% for product in products %}
    {% set refTva = refTva|merge({ (product.tva.value)~'%' : 0 }) %}
{% endfor %}
{% block body %}
    <div class="progress">
        <div class="progress-bar" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%;">
            <span class="sr-only">Etape : 3 / 4</span>
        </div>
    </div>
    <h2>Récapitulatif de la commande</h2>
    <hr>
    <h4> Vos produits : </h4>
    <form>
        <table class="table table-striped table-hover">
            <thead>
            <tr>
                <th>Références</th>
                <th>Nom</th>
                <th>Quantité</th>
                <th>Prix unitaire</th>
                <th>Total HT</th>
            </tr>
            </thead>
            <tbody>
            {% for product in products %}
                <tr>
                    <td>{{ product.reference }}</td>
                    <td>{{ product.name }}</td>
                    <td>{{  cart[product.id] }} </td>
                    <td>{{ product.price }}€</td>
                    <td>{{ product.price * cart[product.id] }} €</td>
                </tr>
                {% set totalHT = totalHT + product.price * cart[product.id] %}
                {% set totalTTC = totalTTC + (product.price*cart[product.id]|tva(product.tva.multiplicate)) %}
                {% set tva = tva + ((product.price*cart[product.id]|tva(product.tva.multiplicate)) - product.price * cart[product.id] ) %}
                {% set refTva = refTva|merge({(product.tva.value~'%') : refTva[product.tva.value~'%'] + (product.price * cart[product.id])|amountTva(product.tva.multiplicate)}) %}
            {% endfor %}
            </tbody>
        </table>
    </form>
    <br>
    <dl class="dl-horizontal pull-right">
        <dt>Total HT :</dt>
        <dd>{{ totalHT }}€</dd>
        {% for key,tva in refTva %}
            <dt> TVA  {{ key }} :</dt>
            <dd> {{ tva }}€</dd>
        {% endfor %}
        <dt>Total TTC :</dt>
        <dd>{{ totalTTC }}€</dd>
    </dl>
    <hr>
    </div>
    <div class="row">
        <div class="span4">
            <h3> Adresse de facturation</h3>
            <address>
                <strong>{{ delivery.user.lastname }} {{ delivery.user.firstname }}</strong><br>
                {{ delivery.user.email }}
                {{ delivery.phone }}<br>
                {{ delivery.adress }}<br>
                {{ delivery.city }} | {{ delivery.postcode }} <br>
                {{ delivery.country }}
            </address>
        </div>
        <div class="span4">
            <h3> Adresse de Livraison</h3>
            <address>
                <strong>{{ delivery.user.lastname }} {{ delivery.user.firstname }}</strong><br>
                {{ delivery.user.email }}
                {{ delivery.phone }}<br>
                {{ delivery.adress }}<br>
                {{ delivery.city }} | {{ delivery.postcode }} <br>
                {{ delivery.country }}
            </address>
        </div>
    </div>
    <div class="clearfix"></div>
    <a href="#" class="btn btn-success pull-right">Confirmer et payer</a>
    </div></div>
{% endblock %}